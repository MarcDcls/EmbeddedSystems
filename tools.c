#include <avr/io.h>
#include <util/delay.h>
#include <time.h>
#include <avr/interrupt.h>

#include "tools.h"
#include "spi.h"

void blue_led_debug()
{
    // Make the blue LED blink 1 time
    DDRD |= _BV(PD6); // Blue LED as output
    PORTD |= _BV(PD6);
    _delay_ms(200);
    PORTD &= ~_BV(PD6);
    _delay_ms(200);
}

uint16_t dizheure[3][60] = {{0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000011100000000, 0b0000111110000000, 0b0000100011000000, 0b0000010001000000, 0b0000011001000000, 0b0000001101000000, 0b0000000111000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000},
                            {0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000010000000000, 0b0000011000000000, 0b0000011100000000, 0b0000010110000000, 0b0000000011000000, 0b0000000011000000, 0b0000000001000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000},
                            {0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000011100000000, 0b0000110100000000, 0b0000100100000000, 0b0000100100000000, 0b0000000100100000, 0b0000000111100000, 0b0000000111000000, 0b0000000100000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000}};
uint16_t uniheure[5][60] = {
    {0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000111000000, 0b0000001111000000, 0b0000001001000000, 0b0000011001000000, 0b0000110011000000, 0b0000100110000000, 0b0000011100000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000},
    {0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000010000000, 0b0000000010000000, 0b0000000110000000, 0b0000001100000000, 0b0000011000000000, 0b0000111000000000, 0b0000001100000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000},
    {0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000110000000, 0b0000000011100000, 0b0000000011100000, 0b0000011111100000, 0b0000110000000000, 0b0000100000000000, 0b0000011000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000},
};
uint16_t dizminutes[1][60] = {
    {0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000111000000, 0b0000001111000000, 0b0000011001000000, 0b0000010001000000, 0b0000100011000000, 0b0000100110000000, 0b0000011100000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000},

};
uint16_t uniminutes[1][60] = {
    {0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000011000000000, 0b0000111110000000, 0b0000100011000000, 0b0000110011000000, 0b0000011001000000, 0b0000001101000000, 0b0000000111000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000},

};
uint16_t image[240] = {0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000001000000000, 0b0000011100000000, 0b0000011100000000, 0b0000011100000000, 0b0000011100000000, 0b0000111100000000, 0b0000100100000000, 0b0000100100000000, 0b0000100100000000, 0b0000100100000000, 0b0000100100000000, 0b0000110100000000, 0b0000110110000000, 0b0000100110000000, 0b0000000100000000, 0b0000000100100000, 0b0000000100100000, 0b0000000100100000, 0b0000000101100000, 0b0000000101100000, 0b0000000101100000, 0b0000000111100000, 0b0000000111100000, 0b0000000111100000, 0b0000000111000000, 0b0000000111000000, 0b0000000111000000, 0b0000000110000000, 0b0000000110000000, 0b0000000110000000, 0b0000000100000000, 0b0000000100000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000110000000, 0b0000000110000000, 0b0000000111000000, 0b0000001111000000, 0b0000001111000000, 0b0000000111000000, 0b0000000101000000, 0b0000000001000000, 0b0000000001000000, 0b0000000001000000, 0b0000000001000000, 0b0000000001000000, 0b0000000001000000, 0b0000000001000000, 0b0000000001000000, 0b0000000011000000, 0b0000111111000000, 0b0001111111000000, 0b0001111111000000, 0b0001111111000000, 0b0000111110000000, 0b0000100010000000, 0b0000110000000000, 0b0000110000000000, 0b0000010000000000, 0b0000010000000000, 0b0000010000000000, 0b0000010000000000, 0b0000011000000000, 0b0000010000000000, 0b0000010000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000010000000000, 0b0000010000000000, 0b0000011000000000, 0b0000011000000000, 0b0000011000000000, 0b0000011000000000, 0b0000011000000000, 0b0000111000000000, 0b0000111000000000, 0b0000111000000000, 0b0000101000000000, 0b0000101000000000, 0b0001101000000000, 0b0001101000000000, 0b0000001001000000, 0b0000001001000000, 0b0000001001000000, 0b0000001001000000, 0b0000001001000000, 0b0000001001000000, 0b0000001001000000, 0b0000001001000000, 0b0000001001000000, 0b0000001001000000, 0b0000001101000000, 0b0000001101000000, 0b0000001111000000, 0b0000001111000000, 0b0000000111000000, 0b0000000111000000, 0b0000000110000000, 0b0000000010000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000100000000, 0b0000000100000000, 0b0000000110000000, 0b0000000110000000, 0b0000000111000000, 0b0000000111000000, 0b0000000011000000, 0b0000000011100000, 0b0000000011100000, 0b0000000001100000, 0b0000000001100000, 0b0000000001100000, 0b0000000011100000, 0b0000001111100000, 0b0000011111100000, 0b0000011111100000, 0b0000011111100000, 0b0000111111000000, 0b0000111010000000, 0b0000110000000000, 0b0000100000000000, 0b0000100000000000, 0b0000100000000000, 0b0000100000000000, 0b0000100000000000, 0b0000110000000000, 0b0000111000000000, 0b0000011000000000, 0b0000011000000000, 0b0000011000000000, 0b0000011000000000, 0b0000001000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000, 0b0000000000000000};

void displayTime(uint16_t *leds, uint32_t resolution, uint16_t seconds)
{
    for (int i = 0; i < resolution; ++i)
    {
        leds[i] = dizheure[0][i] | uniheure[0][i] | dizminutes[0][i] | uniminutes[0][i];
    }
}

void blue_led_blink(int duration)
{
    // Make the blue LED blink each second
    // duration are in seconds
    // Its a blocking function
    DDRD |= _BV(PD6); // Blue LED as output
    int elapsed_time = 0;
    while (elapsed_time < duration)
    {
        PORTD |= _BV(PD6);
        _delay_ms(1000);
        PORTD &= ~_BV(PD6);
        _delay_ms(1000);
        elapsed_time += 2;
    }
}

int is_magnet_dectected()
{
    // Return 1 if a magnet is detected by the hall sensor
    // Return 0 otherwise
    DDRD &= ~_BV(PD2); // Hall sensor as input
    if (PIND & _BV(2))
        return 0;
    return 1;
}

void quarter(int duration)
{
    struct tm initial_tm;
    struct tm current_tm;
    SPI_MasterInit();
    while (current_tm.tm_sec - initial_tm.tm_sec < duration)
    {
        if (is_magnet_dectected())
        {
            SPI_MasterTransmit(0b1000000000000000);
            _delay_ms(13);
            SPI_MasterTransmit(0x00);
        }
        struct tm current_tm;
    }
}

uint16_t min(uint16_t a, uint16_t b)
{
    if (a > b)
        return b;
    return a;
}

int max(int a, int b)
{
    if (a < b)
        return b;
    return a;
}

int abs(int a)
{
    if (a < 0)
        return -a;
    return a;
}

float mean(int *list, int len)
{
    int sum = 0;
    for (int i = 0; i < len; i++)
    {
        sum += list[i];
    }
    return sum / len;
}

uint16_t power(int x, int n)
{
    uint16_t res = 1;
    for (int i = 0; i < n; i++)
    {
        res *= x;
    }
    return res;
}
